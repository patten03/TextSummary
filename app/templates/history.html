<!DOCTYPE html>
<meta charset="UTF-8">
<html>
  <head>
    <style>
      body,
      html {
        height: 100%;
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      html{
        background: repeating-linear-gradient(
        45deg, 
        black,
        black 5%,
        transparent 5%,
        transparent 7%,
        black 7%,
        black 12%,
        transparent 12%,
        transparent 14%,
        black 14%,
        black 19%,
        transparent 19%,
        transparent 100%
        );
      }

      .box {
        width: 90vw;
        max-width: 1400px;
      }
      .bar {
          width: 100%;
          display: flex;
          align-items: center;
          justify-content: space-between;
          padding: 10px;
          box-sizing: border-box;
          background: black;
          color: white;
          margin-bottom: 20px;
      }
      .title {
          font-size: xx-large;
      }
      .main_button {
          width: 10%;
          min-width: 100px;
      }
      .main_button button {
          width: 100%;
          background: transparent;
          color: white;
          border: 1px solid white;
          font-size: large;
          cursor: pointer;
      }

      table {
        table-layout: fixed;
        border-collapse: collapse;
        background-color: white;
        width: 100%;
      }      
      th {
        position: sticky;
        top: 0;
        background-color: black;
        color: white;
      }
      .container {  
        max-height: 60vh;
        overflow-y: auto;  
      }
      tr:nth-child(even) {
        background-color: lightgrey;
      }
      tr:nth-child(odd) {
        background-color: white;
      }
      th, td {
        padding: 12px;
      }
    </style>
  </head>

  <body>
    <div class="box">
      <div class="bar">
        <div class="title">
          Суммаризатор текстов
        </div>
        <div class="main_button">
          <button onclick="window.location.href='/'">
            Главная страница
          </button>
        </div>
      </div>

      <div class="container">
        <div id="loading">
         Загрузка истории…
        </div>
      </div>
    </div>
  </body>

<script>
    async function loadHistory() {
      const container = document.querySelector('.container');
      const loading = document.getElementById('loading');

      try {
        const response = await fetch('/history');
        
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const history = await response.json();

        loading.remove();

        if (!history || history.length === 0) {
          container.innerHTML = '<div class="empty">История пуста</div>';
          return;
        }

        const table = document.createElement('table');
        table.innerHTML = `
          <thead>
            <tr>
              <th style="width:120px;">Дата и время</th>
              <th>Оригинальный текст</th>
              <th style="width:160px;">Инструкция</th>
              <th>Результат</th>
            </tr>
          </thead>
          <tbody></tbody>
        `;

        const tbody = table.querySelector('tbody');

        history.forEach(item => {
          const date = new Date(item.created_at * 1000).toLocaleString('ru-RU', {
            day: '2-digit',
            month: '2-digit',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });

          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="created_at">${date}</td>
            <td title="${escapeHtml(item.original_text)}">${item.original_text}</td>
            <td title="${escapeHtml(item.instruction || '')}">${item.instruction}</td>
            <td title="${escapeHtml(item.result)}">${item.result}</td>
          `;
          tbody.appendChild(row);
        });

        container.appendChild(table);

      } catch (err) {
        console.error(err);
        loading.textContent = 'Ошибка загрузки: ' + err.message;
        loading.style.color = '#ef4444';
      }
    }

    function truncate(str, n) {
      return str && str.length > n ? str.slice(0, n) + '…' : str || '';
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    document.addEventListener('DOMContentLoaded', loadHistory);
  </script>
</html>
